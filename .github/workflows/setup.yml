name: Laravel Server Setup

on:
  push:
    branches: [ "setup" ]

jobs:
  init-server:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Laravel Server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # ✅ تحديث النظام
            sudo apt update && sudo apt upgrade -y

            # ✅ تثبيت PHP + Extensions + MySQL + Composer + Git + Unzip
            sudo apt install -y php-cli php-mbstring unzip curl git \
              php-xml php-bcmath php-mysql mysql-server composer

            # ✅ إنشاء قاعدة البيانات + يوزر
            sudo mysql -e "CREATE DATABASE IF NOT EXISTS ${{ secrets.DB_DATABASE }} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
            sudo mysql -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON ${{ secrets.DB_DATABASE }}.* TO '${{ secrets.DB_USERNAME }}'@'localhost';"
            sudo mysql -e "FLUSH PRIVILEGES;"

            # ✅ تجهيز مجلد المشروع
            mkdir -p /home/ubuntu/test/action
            cd /home/ubuntu/test/action

            # ✅ سحب المشروع من GitHub
            git clone -b main https://github.com/eng-mohamedemad-dev/actions.git .

            # ✅ إنشاء ملف .env من GitHub Secrets
            cat <<EOT > .env
            APP_NAME=Laravel
            APP_ENV=production
            APP_KEY=
            APP_DEBUG=false
            APP_URL=http://${{ secrets.VPS_HOST }}

            LOG_CHANNEL=stack
            LOG_DEPRECATIONS_CHANNEL=null
            LOG_LEVEL=debug

            DB_CONNECTION=mysql
            DB_HOST=127.0.0.1
            DB_PORT=3306
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            CACHE_DRIVER=file
            QUEUE_CONNECTION=sync
            SESSION_DRIVER=file
            SESSION_LIFETIME=120
            EOT

                        # ✅ Laravel setup
                        composer install --no-interaction --prefer-dist --optimize-autoloader
                        php artisan key:generate
                        php artisan migrate --force
                        php artisan storage:link
                        php artisan config:cache
                        php artisan route:cache
                        php artisan view:cache

                        # ✅ صلاحيات الملفات
                        sudo chown -R ubuntu:www-data storage bootstrap/cache

                        echo "🚀 Server setup completed successfully!"
