name: Laravel CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to AWS EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ø§Ù„Ø±ÙŠØ¨Ùˆ
            REPO_NAME="actions"
            PROJECT_PATH="/var/www/$REPO_NAME"
            
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
            sudo mkdir -p $PROJECT_PATH/storage/framework/cache
            sudo mkdir -p $PROJECT_PATH/storage/framework/sessions
            sudo mkdir -p $PROJECT_PATH/storage/framework/views
            sudo mkdir -p $PROJECT_PATH/storage/logs
            sudo mkdir -p $PROJECT_PATH/bootstrap/cache
            
            # Ø¶Ø¨Ø· Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            sudo chmod -R 775 $PROJECT_PATH/storage
            sudo chmod -R 775 $PROJECT_PATH/bootstrap/cache
            
            # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹
            cd $PROJECT_PATH
            
            # ØªÙƒÙˆÙŠÙ† Git Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø§Ù… (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
            sudo -u www-data git config --global --add safe.directory $PROJECT_PATH || true
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† GitHub (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… www-data Ù…Ø¨Ø§Ø´Ø±Ø©)
            sudo -u www-data git fetch origin main
            sudo -u www-data git reset --hard origin/main
            
            # ØªØ­Ø¯ÙŠØ« ØªØ¨Ø¹ÙŠØ§Øª composer
            sudo -u www-data composer install --no-interaction --prefer-dist --optimize-autoloader
            
            # ØªØ´ØºÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Laravel
            sudo -u www-data php artisan optimize:clear
            sudo -u www-data php artisan config:cache
            sudo -u www-data php artisan route:cache
            sudo -u www-data php artisan view:cache
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Storage Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            sudo -u www-data php artisan storage:link || true
            
            # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ±Ø­ÙŠÙ„Ø§Øª
            sudo -u www-data php artisan migrate --force
            
            # Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù‡Ø§Ù…Ø© Ù„Ù‡Ø§ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            sudo chmod -R 775 $PROJECT_PATH/storage
            sudo chmod -R 775 $PROJECT_PATH/bootstrap/cache
            
            # Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ù…Ù„Ù Ø§Ù„Ø±ÙˆØªØ³ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Route::get('test')
            echo "ğŸ“‚ Ù…Ø­ØªÙˆÙ‰ Ù…Ù„Ù Ø§Ù„Ø±ÙˆØªØ³:"
            sudo cat $PROJECT_PATH/routes/web.php
            
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ nginx Ùˆ PHP-FPM
            sudo systemctl restart php8.3-fpm
            sudo systemctl reload nginx
            
            echo "âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ù†Ø¬Ø§Ø­!"
      
      - name: deploy success
        run: echo "Deploy successful! âœ…"